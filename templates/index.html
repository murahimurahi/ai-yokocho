<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãŠã¯ãªã—æ¨ªä¸</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <main class="container">
    <h1>ãŠã¯ãªã—æ¨ªä¸</h1>
    <p class="subtitle">ã‚„ã•ã—ãè©±ã›ã‚‹ã€ã‚ãŸãŸã‹ã„æ™‚é–“ã‚’ã©ã†ãã€‚</p>

    <div class="guide">
      <ol>
        <li>æ€ã£ãŸã“ã¨ã‚’ä¸€è¨€ã¤ã¶ã‚„ãã€‚</li>
        <li>è©±ã—ã‹ã‘ã‚‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã€‚</li>
        <li>AIãŒã‚„ã•ã—ãè¿”ã—ã¦ãã‚Œã¾ã™ã€‚</li>
      </ol>
    </div>

    <div class="voice-select">
      <label><input type="radio" name="voice" value="misa"> ã¿ã•ã¡ã‚ƒã‚“ï¼ˆå­«å¨˜ï¼‰</label>
      <label><input type="radio" name="voice" value="yuu"> ã‚†ã†ãã‚“ï¼ˆå­«æ¯å­ï¼‰</label>
      <label><input type="radio" name="voice" value="souta" checked> ã‚½ã‚¦ã‚¿ã•ã‚“ï¼ˆæ¯å­ï¼‰</label>
    </div>

    <div class="input-box">
      <textarea id="user_input" placeholder="ä»Šæ—¥ã¯å°‘ã—ç–²ã‚ŒãŸãªâ€¦"></textarea>
      <div class="button-group">
        <button id="mic_btn" class="btn mic">ğŸ™ éŸ³å£°å…¥åŠ›</button>
        <button id="send_btn" class="btn">è©±ã—ã‹ã‘ã‚‹</button>
      </div>
    </div>

    <div id="result" class="result"></div>

    <footer>Â© ãŠã¯ãªã—æ¨ªä¸</footer>
  </main>

  <script>
    const sendBtn = document.getElementById("send_btn");
    const micBtn = document.getElementById("mic_btn");
    const input = document.getElementById("user_input");
    const result = document.getElementById("result");

    // ğŸ¤ éŸ³å£°å…¥åŠ›
    micBtn.addEventListener("click", () => {
      const rec = new webkitSpeechRecognition();
      rec.lang = "ja-JP";
      rec.start();
      rec.onresult = (e) => {
        input.value = e.results[0][0].transcript;
      };
    });

    // ğŸ§ éŸ³å£°èª­ã¿ä¸Šã’
    function speakText(text, voiceType) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "ja-JP";

      // ã‚­ãƒ£ãƒ©ã”ã¨ã®å£°è³ªèª¿æ•´
      switch (voiceType) {
        case "misa":
          utter.pitch = 1.4;
          utter.rate = 1.05;
          break;
        case "yuu":
          utter.pitch = 1.2;
          utter.rate = 1.2;
          break;
        case "souta":
          utter.pitch = 0.8;
          utter.rate = 0.95;
          break;
      }

      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    }

    // âœ‰ï¸ AIè¿”ç­”
    sendBtn.addEventListener("click", async () => {
      const text = input.value.trim();
      if (!text) return;

      const voiceType = document.querySelector("input[name='voice']:checked").value;
      result.textContent = "è€ƒãˆä¸­ã§ã™â€¦";

      const res = await fetch("/talk", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_input: text, voice_type: voiceType }),
      });

      const data = await res.json();
      if (data.reply) {
        result.textContent = data.reply;
        speakText(data.reply, voiceType); // â† è‡ªå‹•ã§å£°ã‚’å†ç”Ÿ
      } else {
        result.textContent = "å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚";
      }
    });
  </script>
</body>
</html>
