<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>おはなし横丁</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="bg"><div class="radial"></div></div>

  <main class="card">
    <header class="hero">
      <h1>おはなし横丁</h1>
      <p class="lead">ゆっくり、やさしく、話しましょう。</p>
    </header>

    <section class="use">
      <details open>
        <summary>つかいかた</summary>
        <ol>
          <li>白いところに話したいことを書きます。</li>
          <li><strong>話しかける</strong>を押すと、AIがお返事します。</li>
          <li>「声で聞く」にチェックで読み上げできます。</li>
        </ol>
      </details>
    </section>

    <section class="io">
      <textarea id="userInput" rows="4" placeholder="例）今日は散歩で風が気持ちよかったです。"></textarea>

      <div class="row">
        <button id="talkBtn" class="btn primary">話しかける</button>

        <label class="chk">
          <input type="checkbox" id="speakToggle" />
          声で聞く
        </label>

        <button id="micBtn" class="btn mic" title="音声入力（Chrome推奨）">🎤 声で話す</button>
      </div>

      <div id="result" class="result" aria-live="polite"></div>
    </section>

    <footer class="foot">
      <small>© おはなし横丁</small>
    </footer>
  </main>

  <script>
    // 波紋エフェクト
    document.addEventListener("click",(e)=>{
      const b = e.target.closest(".btn");
      if(!b) return;
      const r = b.getBoundingClientRect();
      b.style.setProperty("--x", `${e.clientX - r.left}px`);
      b.style.setProperty("--y", `${e.clientY - r.top}px`);
    });

    const inputEl = document.getElementById("userInput");
    const resultEl = document.getElementById("result");
    const btn = document.getElementById("talkBtn");
    const speakToggle = document.getElementById("speakToggle");
    const micBtn = document.getElementById("micBtn");

    btn.addEventListener("click", async () => {
      const text = (inputEl.value || "").trim();
      if (!text) { flash("一言でも大丈夫ですよ。"); return; }
      lock(true);
      resultEl.textContent = "考えています…";
      try {
        const res = await fetch("/talk", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ user_input: text })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        resultEl.textContent = data.reply;
        if (speakToggle.checked) speakText(data.reply);
        inputEl.value = "";
      } catch (e) {
        resultEl.textContent = "エラー：" + e.message;
      } finally {
        lock(false);
      }
    });

    function lock(v){ btn.disabled=v; micBtn.disabled=v; }
    function flash(msg){ resultEl.textContent=msg; setTimeout(()=>{resultEl.textContent=""},2000); }

    // 音声入力
    let recog;
    if ("webkitSpeechRecognition" in window) {
      recog = new webkitSpeechRecognition();
      recog.lang = "ja-JP";
      recog.onresult = (e) => {
        inputEl.value = e.results[0][0].transcript;
        flash("入力しました。");
      };
      recog.onerror = () => flash("うまく聞き取れませんでした。");
    } else {
      micBtn.style.display="none";
    }
    micBtn.addEventListener("click",()=>{ if(recog) recog.start(); });

    // 読み上げ
    function speakText(t){
      const u=new SpeechSynthesisUtterance(t);
      u.lang="ja-JP";
      u.rate=0.95;u.pitch=1.0;
      speechSynthesis.speak(u);
    }
  </script>
</body>
</html>
